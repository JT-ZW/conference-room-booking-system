{% extends "layout.html" %} {% block title %} {% if booking %}Edit Booking{%
else %}New Booking{% endif %} | Rainbow Towers Conference Booking {% endblock %}
{% block extra_css %}
<!-- Select2 CSS for autofill functionality -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
/>
<!-- Flatpickr CSS for date/time picker -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>

<style>
  .form-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .form-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    padding: 2rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e9ecef;
  }

  .section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #3498db;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .form-label {
    font-weight: 600;
    color: #34495e;
    margin-bottom: 0.5rem;
  }

  .form-control,
  .form-select {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s ease;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
  }

  .capacity-indicator {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .capacity-progress {
    height: 25px;
    border-radius: 12px;
    overflow: hidden;
  }

  .capacity-text {
    font-weight: 500;
    margin-bottom: 0.5rem;
  }

  /* Updated capacity progress bar colors */
  .capacity-green {
    background-color: #28a745 !important;
  }

  .capacity-orange {
    background-color: #fd7e14 !important;
  }

  .capacity-red {
    background-color: #dc3545 !important;
  }

  .capacity-over {
    background-color: #721c24 !important;
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
  }

  .pricing-item {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }

  .pricing-item:hover {
    border-color: #3498db;
    background: #f0f8ff;
  }

  .pricing-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
    position: sticky;
    top: 2rem;
  }

  .total-amount {
    font-size: 1.8rem;
    font-weight: bold;
    text-align: center;
    margin-top: 1rem;
  }

  .btn-add-item {
    background: #27ae60;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .btn-add-item:hover {
    background: #219a52;
    transform: translateY(-1px);
  }

  .btn-remove-item {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
  }

  .btn-remove-item:hover {
    background: #c0392b;
  }

  .btn-primary-custom {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-primary-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
  }

  .alert-capacity {
    border-radius: 8px;
    border: none;
    font-weight: 500;
  }

  .select2-container--bootstrap-5 .select2-selection {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    min-height: 50px;
  }

  .select2-container--bootstrap-5.select2-container--focus .select2-selection {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
  }

  /* Client Autofill Dropdown Styles */
  .client-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #3498db;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .client-suggestion {
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .client-suggestion:hover {
    background-color: #f8f9fa;
  }

  .client-suggestion.active {
    background-color: #3498db;
    color: white;
  }

  .client-suggestion:last-child {
    border-bottom: none;
  }

  .suggestion-name {
    font-weight: 600;
    display: block;
  }

  .suggestion-company {
    font-size: 0.875rem;
    color: #6c757d;
    display: block;
  }

  .client-suggestion.active .suggestion-company {
    color: rgba(255, 255, 255, 0.8);
  }

  .suggestion-email {
    font-size: 0.75rem;
    color: #8e9aaf;
    font-style: italic;
  }

  .client-suggestion.active .suggestion-email {
    color: rgba(255, 255, 255, 0.7);
  }

  .no-suggestions {
    padding: 1rem;
    text-align: center;
    color: #6c757d;
    font-style: italic;
  }

  .input-with-suggestions {
    position: relative;
  }

  .client-input-loading {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath fill='%236c757d' d='M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z' opacity='.25'/%3E%3Cpath fill='%233498db' d='M12,4a8,8,0,0,1,7.89,6.7A1.53,1.53,0,0,0,21.38,12h0a1.5,1.5,0,0,0,1.48-1.75,11,11,0,0,0-21.72,0A1.5,1.5,0,0,0,2.62,12h0a1.53,1.53,0,0,0,1.49-1.3A8,8,0,0,1,12,4Z'%3E%3CanimateTransform attributeName='transform' dur='0.75s' repeatCount='indefinite' type='rotate' values='0 12 12;360 12 12'/%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 20px;
  }

  .creating-client-notice {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border: 1px solid #4caf50;
    border-radius: 8px;
    padding: 0.75rem;
    margin-top: 0.5rem;
    display: none;
  }

  .required-field::after {
    content: " *";
    color: #dc3545;
    font-weight: bold;
  }
</style>
{% endblock %} 

{% block content %}
<div class="container-fluid form-container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="fas fa-calendar-plus text-primary me-2"></i>
      {% if booking %}Edit Booking{% else %}Create New Booking{% endif %}
    </h2>
    <div>
      <a
        href="{{ url_for('bookings') }}"
        class="btn btn-outline-secondary me-2"
      >
        <i class="fas fa-arrow-left me-1"></i>Back to Bookings
      </a>
      <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        <i class="fas fa-home me-1"></i>Dashboard
      </a>
    </div>
  </div>

  <form method="POST" id="streamlinedBookingForm">
    {{ form.hidden_tag() }}

    <div class="row">
      <!-- Main Form Column -->
      <div class="col-lg-8">
        <!-- Venue & Client Information -->
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-building"></i>
            Venue & Client Details
          </h4>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label required-field">
                <i class="fas fa-map-marker-alt text-primary me-1"></i>
                Select Venue
              </label>
              <select
                class="form-select"
                id="venueSelect"
                name="room_id"
                required
              >
                <option value="">Choose a venue...</option>
                {% for room in rooms %}
                <option
                  value="{{ room.id }}"
                  data-capacity="{{ room.capacity }}"
                  data-hourly="{{ room.hourly_rate or 25 }}"
                  data-halfday="{{ room.half_day_rate or 100 }}"
                  data-fullday="{{ room.full_day_rate or 180 }}"
                  {% if booking and booking.room_id == room.id %}selected{% endif %}
                >
                  {{ room.name }} (Capacity: {{ room.capacity }})
                </option>
                {% endfor %}
              </select>
            </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label required-field">
                <i class="fas fa-users text-primary me-1"></i>
                Number of Guests (PAX)
              </label>
              <input
                type="number"
                class="form-control"
                id="paxInput"
                name="attendees"
                placeholder="Enter expected number of guests"
                min="1"
                value="{{ booking.attendees if booking else '' }}"
                required
              />
            </div>
            <div class="col-md-6">
              <label class="form-label required-field">
                <i class="fas fa-dollar-sign text-primary me-1"></i>
                Currency
              </label>
              <select class="form-select" id="currencyInput" name="currency" required>
                <option value="">Select Currency</option>
                <option value="USD" {% if booking and booking.currency == 'USD' %}selected{% elif not booking %}selected{% endif %}>US$ (United States Dollar)</option>
                <option value="ZWG" {% if booking and booking.currency == 'ZWG' %}selected{% endif %}>ZWG (Zimbabwe Gold)</option>
              </select>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label required-field">
                <i class="fas fa-user text-primary me-1"></i>
                Client Name
              </label>
              <div class="input-with-suggestions">
                <input
                  type="text"
                  class="form-control"
                  id="clientNameInput"
                  name="client_name"
                  placeholder="Start typing client name for suggestions..."
                  value="{{ booking.client.contact_person if booking and booking.client else '' }}"
                  autocomplete="off"
                  required
                />
                <div id="clientSuggestions" class="client-suggestions" style="display: none;"></div>
                <input type="hidden" id="clientIdInput" name="client_id" value="{{ booking.client.id if booking and booking.client else '' }}" />
              </div>
              <div class="creating-client-notice" id="creatingClientNotice">
                <i class="fas fa-plus-circle text-success me-1"></i>
                <small><strong>New Client:</strong> This client will be automatically created when you save the booking.</small>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-briefcase text-primary me-1"></i>
                Company Name
                <small class="text-muted">(Optional)</small>
              </label>
              <div class="input-with-suggestions">
                <input
                  type="text"
                  class="form-control"
                  id="companyNameInput"
                  name="company_name"
                  placeholder="Start typing company name for suggestions..."
                  value="{{ booking.client.company_name if booking and booking.client else '' }}"
                  autocomplete="off"
                />
                <div id="companySuggestions" class="client-suggestions" style="display: none;"></div>
              </div>
            </div>
          </div>

          <!-- Room Capacity Indicator -->
          <div
            class="capacity-indicator"
            id="capacityIndicator"
            style="display: none"
          >
            <div class="capacity-text" id="capacityText">
              Room capacity information
            </div>
            <div class="progress capacity-progress">
              <div
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
                id="capacityProgressBar"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                0%
              </div>
            </div>
            <div class="mt-2" id="capacityAlert"></div>
          </div>
        </div>

        <!-- Event Details -->
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-calendar-alt"></i>
            Event Information
          </h4>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label required-field">
                <i class="fas fa-tag text-primary me-1"></i>
                Event Type
              </label>
              <select
                class="form-select"
                id="eventTypeSelect"
                name="event_type"
                required
              >
                <option value="">Select event type...</option>
                <option value="conference" {% if booking and booking.event_type == 'conference' %}selected{% endif %}>Conference</option>
                <option value="meeting" {% if booking and booking.event_type == 'meeting' %}selected{% endif %}>Business Meeting</option>
                <option value="workshop" {% if booking and booking.event_type == 'workshop' %}selected{% endif %}>Workshop</option>
                <option value="seminar" {% if booking and booking.event_type == 'seminar' %}selected{% endif %}>Seminar</option>
                <option value="training" {% if booking and booking.event_type == 'training' %}selected{% endif %}>Training Session</option>
                <option value="presentation" {% if booking and booking.event_type == 'presentation' %}selected{% endif %}>Presentation</option>
                <option value="board_meeting" {% if booking and booking.event_type == 'board_meeting' %}selected{% endif %}>Board Meeting</option>
                <option value="team_building" {% if booking and booking.event_type == 'team_building' %}selected{% endif %}>Team Building</option>
                <option value="product_launch" {% if booking and booking.event_type == 'product_launch' %}selected{% endif %}>Product Launch</option>
                <option value="other" {% if booking and booking.event_type == 'other' %}selected{% endif %}>Other (specify below)</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-plus-circle text-primary me-1"></i>
                Custom Event Type
              </label>
              <input
                type="text"
                class="form-control"
                id="customEventType"
                name="custom_event_type"
                placeholder="Enter custom event type..."
                value="{{ booking.custom_event_type if booking else '' }}"
                style="{% if not booking or booking.event_type != 'other' %}display: none{% endif %}"
              />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label required-field">
                <i class="fas fa-calendar text-primary me-1"></i>
                Start Date & Time
              </label>
              <input
                type="text"
                class="form-control flatpickr"
                id="startDateTime"
                name="start_time"
                placeholder="Select start date and time"
                value="{{ booking.start_time.strftime('%Y-%m-%d %H:%M') if booking and booking.start_time else '' }}"
                required
              />
            </div>

            <div class="col-md-6">
              <label class="form-label required-field">
                <i class="fas fa-calendar-check text-primary me-1"></i>
                End Date & Time
              </label>
              <input
                type="text"
                class="form-control flatpickr"
                id="endDateTime"
                name="end_time"
                placeholder="Select end date and time"
                value="{{ booking.end_time.strftime('%Y-%m-%d %H:%M') if booking and booking.end_time else '' }}"
                required
              />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-clipboard-list text-primary me-1"></i>
              Event Requirements / Special Notes
            </label>
            <textarea
              class="form-control"
              id="eventRequirements"
              name="notes"
              rows="4"
              placeholder="Enter any special requirements, setup instructions, catering needs, technical requirements, etc."
            >{{ booking.notes if booking else '' }}</textarea>
          </div>
        </div>

        <!-- Simplified Pricing -->
        <div class="form-section">
          <h4 class="section-title">
            <i class="fas fa-dollar-sign"></i>
            Pricing Details
          </h4>

          <div id="pricingItems">
            <!-- Default pricing item -->
            <div class="pricing-item" data-item="0">
              <div class="row align-items-end">
                <div class="col-md-5">
                  <label class="form-label">Item Description</label>
                  <input
                    type="text"
                    class="form-control item-description"
                    name="pricing_items[0][description]"
                    placeholder="e.g., Room rental, Equipment, Catering"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Quantity</label>
                  <input
                    type="number"
                    class="form-control item-quantity"
                    name="pricing_items[0][quantity]"
                    min="1"
                    value="1"
                  />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Unit Price ($)</label>
                  <input
                    type="number"
                    class="form-control item-price"
                    name="pricing_items[0][price]"
                    min="0"
                    step="0.01"
                    placeholder="0.00"
                  />
                </div>
                <div class="col-md-1">
                  <button
                    type="button"
                    class="btn btn-remove-item"
                    onclick="removePricingItem(0)"
                    style="display: none"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-md-12">
                  <div class="text-end">
                    <strong
                      >Subtotal: $<span class="item-subtotal"
                        >0.00</span
                      ></strong
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="text-center mb-3">
            <button
              type="button"
              class="btn btn-add-item"
              onclick="addPricingItem()"
            >
              <i class="fas fa-plus me-1"></i>Add Another Item
            </button>
          </div>
        </div>
      </div>

      <!-- Simplified Pricing Summary Column -->
      <div class="col-lg-4">
        <div class="pricing-summary">
          <h5 class="mb-3 text-center">
            <i class="fas fa-receipt me-2"></i>Pricing Summary
          </h5>

          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <strong id="summarySubtotal">$0.00</strong>
          </div>

          <hr class="bg-light" />

          <div class="total-amount">
            Total: <span id="summaryTotal">$0.00</span>
          </div>

          <div class="d-grid gap-2 mt-4">
            <button type="submit" class="btn btn-primary-custom">
              <i class="fas fa-save me-2"></i>
              {% if booking %}Update Booking{% else %}Create Booking{% endif %}
            </button>

            {% if booking %}
            <a href="{{ url_for('generate_quotation', id=booking.id) }}" class="btn btn-outline-light">
              <i class="fas fa-file-invoice me-2"></i>View Quotation
            </a>
            {% endif %}

            <a href="{{ url_for('bookings') }}" class="btn btn-outline-light">
              <i class="fas fa-times me-2"></i>Cancel
            </a>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %} 

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("ðŸŽ¯ Enhanced booking form loaded with simplified pricing");
    
    // Initialize components
    initializeDateTimePickers();
    initializeVenueSelect();
    initializeClientAutofill();
    initializeCompanyAutofill();
    initializeEventTypeHandler();
    initializePricingCalculation();

    // Global variables for client suggestions
    let clientSuggestionsVisible = false;
    let companySuggestionsVisible = false;
    let selectedSuggestionIndex = -1;
    let clientSuggestions = [];
    let companySuggestions = [];

    // Initialize venue selection
    function initializeVenueSelect() {
      $("#venueSelect").select2({
        theme: "bootstrap-5",
        placeholder: "Choose a venue...",
        allowClear: true,
      });

      $("#venueSelect").on("change", function () {
        updateCapacityIndicator();
        calculatePricing();
      });
    }

    // Enhanced client name autofill with keyboard navigation
    function initializeClientAutofill() {
      const clientInput = document.getElementById('clientNameInput');
      const suggestionsDiv = document.getElementById('clientSuggestions');
      const clientIdInput = document.getElementById('clientIdInput');
      const creatingNotice = document.getElementById('creatingClientNotice');
      
      let searchTimeout;

      clientInput.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(searchTimeout);
        
        if (query.length >= 2) {
          clientInput.classList.add('client-input-loading');
          
          searchTimeout = setTimeout(() => {
            fetchClientSuggestions(query);
          }, 300);
        } else {
          hideSuggestions();
          clientIdInput.value = '';
          creatingNotice.style.display = 'none';
        }
      });

      // Keyboard navigation
      clientInput.addEventListener('keydown', function(e) {
        if (!clientSuggestionsVisible) return;

        switch(e.key) {
          case 'ArrowDown':
            e.preventDefault();
            navigateSuggestions(1);
            break;
          case 'ArrowUp':
            e.preventDefault();
            navigateSuggestions(-1);
            break;
          case 'Enter':
            e.preventDefault();
            selectCurrentSuggestion();
            break;
          case 'Escape':
            hideSuggestions();
            break;
        }
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!clientInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          hideSuggestions();
        }
      });

      function fetchClientSuggestions(query) {
        fetch(`/api/clients/search?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            clientInput.classList.remove('client-input-loading');
            displayClientSuggestions(data);
          })
          .catch(error => {
            console.error('Error fetching client suggestions:', error);
            clientInput.classList.remove('client-input-loading');
          });
      }

      function displayClientSuggestions(suggestions) {
        clientSuggestions = suggestions;
        selectedSuggestionIndex = -1;
        
        if (suggestions.length === 0) {
          suggestionsDiv.innerHTML = '<div class="no-suggestions">No existing clients found. A new client will be created.</div>';
          creatingNotice.style.display = 'block';
        } else {
          let html = '';
          suggestions.forEach((suggestion, index) => {
            html += `
              <div class="client-suggestion" data-index="${index}" onclick="selectClientSuggestion(${index})">
                <span class="suggestion-name">${suggestion.name}</span>
                ${suggestion.company ? `<span class="suggestion-company">${suggestion.company}</span>` : ''}
                <span class="suggestion-email">${suggestion.email}</span>
              </div>
            `;
          });
          suggestionsDiv.innerHTML = html;
          creatingNotice.style.display = 'none';
        }
        
        suggestionsDiv.style.display = 'block';
        clientSuggestionsVisible = true;
      }

      function navigateSuggestions(direction) {
        const suggestionElements = suggestionsDiv.querySelectorAll('.client-suggestion');
        if (suggestionElements.length === 0) return;

        // Remove current active class
        if (selectedSuggestionIndex >= 0) {
          suggestionElements[selectedSuggestionIndex].classList.remove('active');
        }

        // Calculate new index
        selectedSuggestionIndex += direction;
        if (selectedSuggestionIndex < 0) {
          selectedSuggestionIndex = suggestionElements.length - 1;
        } else if (selectedSuggestionIndex >= suggestionElements.length) {
          selectedSuggestionIndex = 0;
        }

        // Add active class to new selection
        suggestionElements[selectedSuggestionIndex].classList.add('active');
        suggestionElements[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
      }

      function selectCurrentSuggestion() {
        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < clientSuggestions.length) {
          selectClientSuggestion(selectedSuggestionIndex);
        }
      }

      function hideSuggestions() {
        suggestionsDiv.style.display = 'none';
        clientSuggestionsVisible = false;
        selectedSuggestionIndex = -1;
      }

      // Make functions globally accessible
      window.selectClientSuggestion = function(index) {
        const suggestion = clientSuggestions[index];
        clientInput.value = suggestion.name;
        clientIdInput.value = suggestion.id;
        
        // Auto-fill company name if available
        if (suggestion.company) {
          document.getElementById('companyNameInput').value = suggestion.company;
        }
        
        hideSuggestions();
        creatingNotice.style.display = 'none';
        
        console.log(`âœ… Selected existing client: ${suggestion.name} (ID: ${suggestion.id})`);
      };
    }

    // Enhanced company name autofill
    function initializeCompanyAutofill() {
      const companyInput = document.getElementById('companyNameInput');
      const suggestionsDiv = document.getElementById('companySuggestions');
      
      let searchTimeout;

      companyInput.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(searchTimeout);
        
        if (query.length >= 2) {
          searchTimeout = setTimeout(() => {
            fetchCompanySuggestions(query);
          }, 300);
        } else {
          hideCompanySuggestions();
        }
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!companyInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          hideCompanySuggestions();
        }
      });

      function fetchCompanySuggestions(query) {
        fetch(`/api/companies/search?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(data => {
            displayCompanySuggestions(data);
          })
          .catch(error => {
            console.error('Error fetching company suggestions:', error);
          });
      }

      function displayCompanySuggestions(suggestions) {
        companySuggestions = suggestions;
        
        if (suggestions.length === 0) {
          hideCompanySuggestions();
          return;
        }

        let html = '';
        suggestions.forEach((suggestion, index) => {
          html += `
            <div class="client-suggestion" onclick="selectCompanySuggestion('${suggestion.name}')">
              <span class="suggestion-name">${suggestion.name}</span>
            </div>
          `;
        });
        suggestionsDiv.innerHTML = html;
        suggestionsDiv.style.display = 'block';
        companySuggestionsVisible = true;
      }

      function hideCompanySuggestions() {
        suggestionsDiv.style.display = 'none';
        companySuggestionsVisible = false;
      }

      // Make function globally accessible
      window.selectCompanySuggestion = function(companyName) {
        companyInput.value = companyName;
        hideCompanySuggestions();
        console.log(`âœ… Selected existing company: ${companyName}`);
      };
    }

    // Initialize date/time pickers
    function initializeDateTimePickers() {
      flatpickr(".flatpickr", {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        minuteIncrement: 15,
        minDate: "today",
        onChange: function() {
          calculatePricing();
        }
      });
    }

    // Event type handler
    function initializeEventTypeHandler() {
      $("#eventTypeSelect").on("change", function () {
        if ($(this).val() === "other") {
          $("#customEventType").show().prop("required", true);
        } else {
          $("#customEventType").hide().prop("required", false);
        }
      });
    }

    // Enhanced capacity indicator with improved color coding
    function updateCapacityIndicator() {
      const selectedVenue = $("#venueSelect option:selected");
      const capacity = parseInt(selectedVenue.data("capacity")) || 0;
      const pax = parseInt($("#paxInput").val()) || 0;

      if (capacity && pax > 0) {
        $("#capacityIndicator").show();
        const utilizationPct = Math.min(Math.round((pax / capacity) * 100), 150); // Allow up to 150% for display

        $("#capacityText").text(`${selectedVenue.text()}`);
        $("#capacityProgressBar")
          .css("width", `${Math.min(utilizationPct, 100)}%`)
          .attr("aria-valuenow", utilizationPct)
          .text(`${utilizationPct}%`);

        // Enhanced color coding based on your requirements
        let progressClass = "";
        let alertHtml = "";

        // Remove all existing color classes
        $("#capacityProgressBar").removeClass("capacity-green capacity-orange capacity-red capacity-over bg-success bg-warning bg-danger");

        if (utilizationPct > 100) {
          progressClass = "capacity-over";
          alertHtml = `<div class="alert alert-danger alert-capacity">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    <strong>OVER CAPACITY!</strong> ${pax} guests exceeds room limit of ${capacity}. 
                    Please choose a larger venue or reduce attendee count.
                </div>`;
        } else if (utilizationPct > 90) {
          progressClass = "capacity-red";
          alertHtml = `<div class="alert alert-danger alert-capacity">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    <strong>Near Maximum Capacity:</strong> Room will be ${utilizationPct}% full (${pax} of ${capacity}).
                    Consider a larger venue for comfort.
                </div>`;
        } else if (utilizationPct >= 70) {
          progressClass = "capacity-orange";
          alertHtml = `<div class="alert alert-warning alert-capacity">
                    <i class="fas fa-info-circle me-1"></i>
                    <strong>Good Capacity:</strong> Room will be ${utilizationPct}% full (${pax} of ${capacity}).
                    Comfortable for attendees.
                </div>`;
        } else {
          progressClass = "capacity-green";
          alertHtml = `<div class="alert alert-success alert-capacity">
                    <i class="fas fa-check-circle me-1"></i>
                    <strong>Excellent Capacity:</strong> Room will be ${utilizationPct}% full (${pax} of ${capacity}).
                    Plenty of space for attendees.
                </div>`;
        }

        $("#capacityProgressBar").addClass(progressClass);
        $("#capacityAlert").html(alertHtml);

        console.log(`ðŸ“Š Capacity Update: ${pax}/${capacity} (${utilizationPct}%) - ${progressClass}`);
      } else {
        $("#capacityIndicator").hide();
      }
    }

    // PAX input handler
    $("#paxInput").on("input", updateCapacityIndicator);

    // Simplified pricing calculation (no tax or discount)
    function initializePricingCalculation() {
      $(document).on(
        "input",
        ".item-description, .item-quantity, .item-price",
        calculateItemSubtotal
      );
    }

    function calculateItemSubtotal() {
      const item = $(this).closest(".pricing-item");
      const quantity = parseFloat(item.find(".item-quantity").val()) || 0;
      const price = parseFloat(item.find(".item-price").val()) || 0;
      const subtotal = quantity * price;

      item.find(".item-subtotal").text(subtotal.toFixed(2));
      calculatePricing();
    }

    // Simplified pricing calculation - just sum up all items
    function calculatePricing() {
      let totalSubtotal = 0;

      $(".item-subtotal").each(function () {
        totalSubtotal += parseFloat($(this).text()) || 0;
      });

      // No tax or discount - total equals subtotal
      $("#summarySubtotal").text(`$${totalSubtotal.toFixed(2)}`);
      $("#summaryTotal").text(`$${totalSubtotal.toFixed(2)}`);
    }

    let pricingItemCounter = 1;

    // Add pricing item
    window.addPricingItem = function () {
      const newItem = `
            <div class="pricing-item" data-item="${pricingItemCounter}">
                <div class="row align-items-end">
                    <div class="col-md-5">
                        <label class="form-label">Item Description</label>
                        <input type="text" class="form-control item-description" name="pricing_items[${pricingItemCounter}][description]" 
                               placeholder="e.g., Room rental, Equipment, Catering">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control item-quantity" name="pricing_items[${pricingItemCounter}][quantity]" 
                               min="1" value="1">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Unit Price ($)</label>
                        <input type="number" class="form-control item-price" name="pricing_items[${pricingItemCounter}][price]" 
                               min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-remove-item" onclick="removePricingItem(${pricingItemCounter})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <div class="text-end">
                            <strong>Subtotal: $<span class="item-subtotal">0.00</span></strong>
                        </div>
                    </div>
                </div>
            </div>
        `;
      $("#pricingItems").append(newItem);
      pricingItemCounter++;

      // Show remove button for all items if more than one
      if ($(".pricing-item").length > 1) {
        $(".btn-remove-item").show();
      }
    };

    // Remove pricing item
    window.removePricingItem = function (itemId) {
      $(`.pricing-item[data-item="${itemId}"]`).remove();
      calculatePricing();

      // Hide remove buttons if only one item left
      if ($(".pricing-item").length <= 1) {
        $(".btn-remove-item").hide();
      }
    };

    // Form submission with validation
    $("#streamlinedBookingForm").on("submit", function (e) {
      // Validate required fields
      const requiredFields = ['venueSelect', 'paxInput', 'clientNameInput', 'eventTypeSelect', 'startDateTime', 'endDateTime'];
      let isValid = true;

      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          field.classList.add('is-invalid');
          isValid = false;
        } else {
          field.classList.remove('is-invalid');
        }
      });

      if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return false;
      }

      // Check if we're creating a new client
      const clientIdInput = document.getElementById('clientIdInput');
      const clientNameInput = document.getElementById('clientNameInput');
      
      if (!clientIdInput.value && clientNameInput.value) {
        console.log(`ðŸ†• Creating new client: ${clientNameInput.value}`);
      }

      console.log("âœ… Form submitted successfully");
    });

    // Initialize capacity indicator if editing existing booking
    {% if booking %}
    setTimeout(function() {
      updateCapacityIndicator();
      calculatePricing();
    }, 100);
    {% endif %}

    console.log("ðŸš€ Booking form initialization complete");
  });
</script>
{% endblock %}