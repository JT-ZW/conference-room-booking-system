{% extends "layout.html" %}

{% block content %}
<div class="container my-4">
    <div class="card shadow-lg border-0 position-relative">
        <div class="card-body p-4 content-wrapper" id="invoice-content">
            <!-- Invoice Header -->
            <div class="invoice-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="invoice-title">INVOICE</div>
                        <div class="invoice-subtitle">
                            Rainbow Towers Hotel & Conference Centre
                        </div>
                        <div class="mt-3">
                            <span class="badge bg-light text-primary fs-6">{{ invoice_number }}</span>
                            <span class="badge bg-light text-primary ms-2 fs-6">
                                {{ current_date.strftime('%Y-%m-%d') }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-4 logo-container">
                        <img src="{{ url_for('static', filename='img/rainbow-towers-logo.png') }}" 
                             alt="Rainbow Towers Logo" 
                             class="img-fluid">
                    </div>
                </div>
            </div>

            <!-- Client Info -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Bill To:</h5>
                    <div class="client-info">
                        <strong>{{ booking.client.company_name if booking.client else booking.company_name }}</strong><br>
                        Attn: {{ booking.client.contact_person if booking.client else booking.client_name }}<br>
                        {% if booking.client and booking.client.email %}
                            Email: {{ booking.client.email }}<br>
                        {% endif %}
                        {% if booking.client and booking.client.phone %}
                            Phone: {{ booking.client.phone }}
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <h5>Payment Details:</h5>
                    <div class="payment-info">
                        <p>Due Date: {{ due_date.strftime('%Y-%m-%d') }}<br>
                           Payment Terms: Net 30</p>
                    </div>
                </div>
            </div>

            <!-- Booking Details -->
            <div class="row mt-4">
                <div class="col-12">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if booking.room_rate %}
                            <tr>
                                <td>
                                    Room Hire - {{ booking.room.name }}<br>
                                    <small class="text-muted">
                                        {{ booking.start_time.strftime('%Y-%m-%d %H:%M') }} to 
                                        {{ booking.end_time.strftime('%H:%M') }}
                                    </small>
                                </td>
                                <td class="text-end">${{ "%.2f"|format(booking.room_rate) }}</td>
                            </tr>
                            {% endif %}

                            {% if booking.custom_addons %}
                            {% for addon in booking.custom_addons %}
                            <tr>
                                <td>{{ addon.description }}</td>
                                <td class="text-end">${{ "%.2f"|format(addon.total_price) }}</td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <th>Total Amount</th>
                                <th class="text-end">${{ "%.2f"|format(booking.total_price or 0) }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Notes -->
            {% if booking.notes %}
            <div class="row mt-4">
                <div class="col-12">
                    <h6>Additional Notes:</h6>
                    <p class="mb-0">{{ booking.notes }}</p>
                </div>
            </div>
            {% endif %}

            <!-- Footer -->
            <div class="invoice-footer">
                <p class="mb-0">Thank you for your business!</p>
                <small class="text-muted">
                    Generated on {{ current_date.strftime('%Y-%m-%d %H:%M') }} CAT
                </small>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="text-center mt-4">
        <button onclick="window.print()" class="btn btn-primary">
            <i class="fas fa-print me-2"></i>Print Invoice
        </button>
        <button onclick="downloadPDF()" class="btn btn-success">
            <i class="fas fa-download me-2"></i>Download PDF
        </button>
        <a href="{{ url_for('bookings.view_booking', id=booking.id) }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Booking
        </a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media print {
        .btn { display: none !important; }
        .card { border: none !important; box-shadow: none !important; }
        body { background: white !important; }
    }
    .invoice-title {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2c3e50;
    }
    .invoice-subtitle {
        color: #7f8c8d;
        font-size: 1.2rem;
    }
    .client-info, .payment-info {
        line-height: 1.6;
    }
    .invoice-footer {
        margin-top: 60px;
        padding-top: 20px;
        border-top: 2px solid #eee;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
function downloadPDF() {
    const element = document.getElementById('invoice-content');
    const opt = {
        margin: 1,
        filename: '{{ invoice_number }}.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
}
</script>
{% endblock %}
