<!-- Updated revenue.html template with fixes for all Decimal arithmetic -->

{% extends "layout.html" %} {% block title %}Revenue Report | Rainbow Towers
Conference Booking{% endblock %} {% block extra_css %}
<style>
  .date-range-form .form-control {
    width: auto;
    display: inline-block;
  }

  .revenue-card {
    border-left: 4px solid #4e73df;
  }

  .revenue-card .h5 {
    color: #5a5c69;
  }

  .revenue-card .revenue-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #4e73df;
  }

  .chart-container {
    height: 300px;
  }

  .category-revenue {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .category-revenue:last-child {
    border-bottom: none;
  }

  .category-name {
    font-weight: bold;
    color: #4e73df;
  }

  .progress {
    height: 20px;
  }
</style>
{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1><i class="fas fa-chart-line text-primary me-2"></i>Revenue Report</h1>
  <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left me-1"></i>Back to Reports
  </a>
</div>

<!-- Date Range Filter -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body">
    <form
      method="GET"
      action="{{ url_for('revenue_report') }}"
      class="date-range-form"
    >
      <div class="row align-items-end">
        <div class="col-md-4">
          <label class="form-label">Start Date</label>
          <input
            type="date"
            name="start_date"
            class="form-control"
            value="{{ start_date.strftime('%Y-%m-%d') }}"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label">End Date</label>
          <input
            type="date"
            name="end_date"
            class="form-control"
            value="{{ end_date.strftime('%Y-%m-%d') }}"
          />
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-filter me-1"></i>Apply Filter
          </button>
          <a
            href="{{ url_for('revenue_report') }}"
            class="btn btn-outline-secondary"
          >
            <i class="fas fa-redo me-1"></i>Reset
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Revenue Summary -->
<div class="row mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm border-0 revenue-card">
      <div class="card-body">
        <div class="h5 mb-2">Total Revenue</div>
        <div class="revenue-value">${{ total_revenue }}</div>
        <div class="text-muted">{{ bookings|length }} bookings</div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm border-0 revenue-card">
      <div class="card-body">
        <div class="h5 mb-2">Room Revenue</div>
        <div class="revenue-value">${{ room_revenue }}</div>
        {% set decimal_class = total_revenue.__class__ %} {% if total_revenue >
        0 %} {% set room_percentage = ((room_revenue / total_revenue) *
        decimal_class('100')).quantize(decimal_class('0.1')) %}
        <div class="text-muted">{{ room_percentage }}% of total revenue</div>
        {% else %}
        <div class="text-muted">0% of total revenue</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm border-0 revenue-card">
      <div class="card-body">
        <div class="h5 mb-2">Add-on Revenue</div>
        <div class="revenue-value">${{ addon_revenue }}</div>
        {% if total_revenue > 0 %} {% set addon_percentage = ((addon_revenue /
        total_revenue) * decimal_class('100')).quantize(decimal_class('0.1')) %}
        <div class="text-muted">{{ addon_percentage }}% of total revenue</div>
        {% else %}
        <div class="text-muted">0% of total revenue</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Revenue Charts -->
<div class="row mb-4">
  <!-- Revenue by Room -->
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header bg-white">
        <h5 class="mb-0 text-primary">
          <i class="fas fa-door-open me-2"></i>Revenue by Room
        </h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="roomRevenueChart"></canvas>
        </div>

        <div class="mt-4">
          {% for room, revenue in room_revenues.items() %}
          <div class="category-revenue">
            <div class="d-flex justify-content-between mb-1">
              <span class="category-name">{{ room }}</span>
              <span class="fw-bold">${{ revenue }}</span>
            </div>
            <div class="d-flex justify-content-between mb-1 small text-muted">
              <span>Contribution to Total Revenue</span>
              {% if total_revenue > 0 %} {% set room_percentage = ((revenue /
              total_revenue) *
              decimal_class('100')).quantize(decimal_class('0.1')) %}
              <span>{{ room_percentage }}%</span>
              {% else %}
              <span>0%</span>
              {% endif %}
            </div>
            <div class="progress">
              {% if total_revenue > 0 %} {% set room_percentage_value =
              ((revenue / total_revenue) *
              decimal_class('100')).quantize(decimal_class('0')) %}
              <div
                class="progress-bar"
                role="progressbar"
                style="width: {{ room_percentage_value }}%"
                aria-valuenow="{{ room_percentage_value }}"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
              {% else %}
              <div
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue by Add-on Category -->
  <div class="col-md-6">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-header bg-white">
        <h5 class="mb-0 text-primary">
          <i class="fas fa-plus-circle me-2"></i>Revenue by Add-on Category
        </h5>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="addonRevenueChart"></canvas>
        </div>

        <div class="mt-4">
          {% for category, revenue in addon_revenues.items() %}
          <div class="category-revenue">
            <div class="d-flex justify-content-between mb-1">
              <span class="category-name">{{ category }}</span>
              <span class="fw-bold">${{ revenue }}</span>
            </div>
            <div class="d-flex justify-content-between mb-1 small text-muted">
              <span>Contribution to Add-on Revenue</span>
              {% if addon_revenue > 0 %} {% set category_percentage = ((revenue
              / addon_revenue) *
              decimal_class('100')).quantize(decimal_class('0.1')) %}
              <span>{{ category_percentage }}%</span>
              {% else %}
              <span>0%</span>
              {% endif %}
            </div>
            <div class="progress">
              {% if addon_revenue > 0 %} {% set category_percentage_value =
              ((revenue / addon_revenue) *
              decimal_class('100')).quantize(decimal_class('0')) %}
              <div
                class="progress-bar bg-success"
                role="progressbar"
                style="width: {{ category_percentage_value }}%"
                aria-valuenow="{{ category_percentage_value }}"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
              {% else %}
              <div
                class="progress-bar bg-success"
                role="progressbar"
                style="width: 0%"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Bookings -->
<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white">
    <h5 class="mb-0 text-primary">
      <i class="fas fa-list me-2"></i>Recent Bookings
    </h5>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Booking</th>
            <th>Client</th>
            <th>Room</th>
            <th>Date</th>
            <th class="text-end">Room Charges</th>
            <th class="text-end">Add-on Charges</th>
            <th class="text-end">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in bookings %}
          <tr>
            <td>
              <a
                href="{{ url_for('view_booking', id=booking.id) }}"
                class="text-decoration-none"
              >
                {{ booking.title }}
              </a>
            </td>
            <td>
              {{ booking.client.company_name or booking.client.contact_person }}
            </td>
            <td>{{ booking.room.name }}</td>
            <td>{{ booking.start_time.strftime('%d %b %Y') }}</td>
            <td class="text-end">${{ booking.room_rate }}</td>
            <td class="text-end">${{ booking.addons_total }}</td>
            <td class="text-end fw-bold">${{ booking.total_price }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="7" class="text-center py-4">
              <p class="text-muted mb-0">
                No bookings found in the selected date range
              </p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Revenue by Room Chart
      const roomCtx = document.getElementById('roomRevenueChart').getContext('2d');
      const roomRevenueChart = new Chart(roomCtx, {
          type: 'doughnut',
          data: {
              labels: [{% for room, revenue in room_revenues.items() %}'{{ room }}',{% endfor %}],
              datasets: [{
                  data: [{% for room, revenue in room_revenues.items() %}{{ revenue }},{% endfor %}],
                  backgroundColor: [
                      '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796',
                      '#5a5c69', '#2e59d9', '#17a673', '#2c9faf', '#ffbf00', '#d52a1a'
                  ],
                  hoverOffset: 4
              }]
          },
          options: {
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              }
          }
      });

      // Revenue by Add-on Category Chart
      const addonCtx = document.getElementById('addonRevenueChart').getContext('2d');
      const addonRevenueChart = new Chart(addonCtx, {
          type: 'doughnut',
          data: {
              labels: [{% for category, revenue in addon_revenues.items() %}'{{ category }}',{% endfor %}],
              datasets: [{
                  data: [{% for category, revenue in addon_revenues.items() %}{{ revenue }},{% endfor %}],
                  backgroundColor: [
                      '#1cc88a', '#4e73df', '#36b9cc', '#f6c23e', '#e74a3b', '#858796',
                      '#5a5c69', '#17a673', '#2e59d9', '#2c9faf', '#ffbf00', '#d52a1a'
                  ],
                  hoverOffset: 4
              }]
          },
          options: {
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              }
          }
      });
  });
</script>
{% endblock %}
